
/*!
 * Lightweight Legacy-Compatible QR Scanner
 * Works without modules, supports QrScanner.WORKER_PATH (ignored)
 * Uses native BarcodeDetector when available
 */

(function(global){
    function QrScanner(videoElem, onDecode, options){
        this.video = videoElem;
        this.onDecode = onDecode;
        this.active = false;
        this.opts = options || {};
    }

    QrScanner.WORKER_PATH = "";

    QrScanner.prototype.start = async function(){
        if (!navigator.mediaDevices) {
            console.error("Camera not supported");
            return;
        }
        this.active = true;
        try {
            const facing = this.opts.preferredCamera === "user" ? "user" : "environment";
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: facing }
            });
            this.video.srcObject = stream;
            await this.video.play();
            this.scanLoop();
        } catch (e) {
            console.error("Camera error", e);
        }
    };

    QrScanner.prototype.stop = function(){
        this.active = false;
        if (this.video.srcObject){
            this.video.srcObject.getTracks().forEach(t=>t.stop());
        }
    };

    QrScanner.prototype.scanLoop = async function(){
        if (!this.active) return;
        try {
            if ('BarcodeDetector' in window){
                const detector = new BarcodeDetector({ formats: ['qr_code'] });
                const results = await detector.detect(this.video);
                if (results.length > 0){
                    this.onDecode(results[0].rawValue);
                }
            }
        } catch(e){
            console.warn("Scan error", e);
        }
        requestAnimationFrame(this.scanLoop.bind(this));
    };

    global.QrScanner = QrScanner;
})(window);
